<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Far But Close</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; text-align: center; background: #fafafa; padding: 20px; }
    input, button { padding: 10px; margin: 10px; width: 80%; max-width: 300px; }
    .hidden { display: none; }
  </style>
</head>
<body>

  <div id="register">
    <h2>Добро пожаловать в Far But Close</h2>
    <p>Игра для влюбленных на расстоянии</p>
    <input type="text" id="tgName" placeholder="Ваше имя">
    <input type="text" id="partner" placeholder="Имя партнёра">
    <input type="date" id="startDate">
    <button onclick="registerUser()">Начать</button>
    <div id="regError" style="color: red;"></div>
  </div>

  <div id="main" class="hidden">
    <h2>Привет, <span id="nameDisplay"></span>!</h2>
    <p>Вы вместе с <span id="partnerDisplay"></span> с <span id="dateDisplay"></span></p>
  </div>

  <script>
    let userId = localStorage.getItem('fake_user_id') || Math.floor(Math.random() * 1000000000);
    localStorage.setItem('fake_user_id', userId);

    async function registerUser() {
      const tgName = document.getElementById('tgName').value.trim();
      const partner = document.getElementById('partner').value.trim();
      const startDate = document.getElementById('startDate').value;

      if (!tgName || !partner || !startDate) {
        document.getElementById('regError').innerText = "Пожалуйста, заполните все поля.";
        return;
      }

      const userData = {
        user_id: userId,
        name: tgName,
        partner: partner,
        date: startDate
      };

      console.log("Отправка данных:", userData); // Отладка

      try {
        const res = await fetch('save_user.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(userData)
        });

        const text = await res.text();
        console.log("Ответ сервера:", text);

        if (text.trim() === "OK") {
          localStorage.setItem('user_data', JSON.stringify(userData));
          showMainScreen(userData);
        } else {
          document.getElementById('regError').innerText = "Ошибка при сохранении: " + text;
        }
      } catch (e) {
        document.getElementById('regError').innerText = "Ошибка подключения к серверу";
        console.error(e);
      }
    }

    function showMainScreen(data) {
      document.getElementById('register').classList.add('hidden');
      document.getElementById('main').classList.remove('hidden');
      document.getElementById('nameDisplay').innerText = data.name;
      document.getElementById('partnerDisplay').innerText = data.partner;
      document.getElementById('dateDisplay').innerText = data.date;
    }

    // При повторном входе — загружаем из localStorage
    window.onload = () => {
      const saved = localStorage.getItem('user_data');
      if (saved) {
        const data = JSON.parse(saved);
        showMainScreen(data);
      }
    };
  </script>

</body>
</html>