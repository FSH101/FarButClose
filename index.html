<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Far But Close</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #fbd3e9, #bb377d);
      color: white;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      background-color: rgba(255, 255, 255, 0.05);
    }
    .main {
      padding: 20px;
    }
    #feed {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 10px;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 10px;
    }
    #feed p {
      background: rgba(255, 255, 255, 0.2);
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
    }
    #newPost {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    textarea {
      width: 100%;
      height: 60px;
      padding: 10px;
      font-family: inherit;
      font-size: 16px;
      border: none;
      border-radius: 6px;
    }
    button.send {
      background-color: #ffffff30;
      border: none;
      padding: 10px;
      border-radius: 6px;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <div>Вы: <span id="userName">...</span> | Партнёр: <span id="partnerName">не назначен</span></div>
    <div>Монеты: <span id="coinCount">0</span></div>
  </header>

  <div class="main">
    <div id="feed"></div>

    <form id="newPost" onsubmit="sendPost(event)">
      <textarea id="postContent" placeholder="Напиши что-то..."></textarea>
      <button class="send">Отправить</button>
    </form>
  </div>

  <script>
    let userName = Telegram.WebApp.initDataUnsafe?.user?.first_name || "Вы";
    let userId = Telegram.WebApp.initDataUnsafe?.user?.id;
    let partnerName = "";
    let coinCount = 0;

    document.getElementById("userName").innerText = userName;

    // Загрузить данные пользователя (если они есть)
    function loadUserData() {
      fetch(`save_user.php?user_id=${userId}`)
        .then(res => res.json())
        .then(data => {
          if (data) {
            partnerName = data.partner;
            coinCount = data.coins;
            document.getElementById("partnerName").innerText = partnerName || "не назначен";
            document.getElementById("coinCount").innerText = coinCount;
          }
        });
    }

    // Загрузить все посты из ленты
    function loadFeed() {
      fetch('load_feed.php')
        .then(res => res.json())
        .then(data => {
          const feed = document.getElementById("feed");
          feed.innerHTML = "";
          data.forEach(entry => {
            const p = document.createElement("p");
            p.innerText = `${entry.name}: ${entry.text}`;
            feed.appendChild(p);
          });
        });
    }

    // Отправить пост в ленту
    function sendPost(event) {
      event.preventDefault();
      const content = document.getElementById("postContent").value.trim();
      if (!content) return;

      fetch('save_post.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_id: userId,
          name: userName,
          text: content
        })
      }).then(() => {
        document.getElementById("postContent").value = "";
        loadFeed();
      });
    }

    // Инициализация
    loadUserData();
    loadFeed();
  </script>
</body>
</html>