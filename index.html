<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Far But Close</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="register">
    <h2>Добро пожаловать в Far But Close</h2>
    <p>Игра для влюблённых на расстоянии</p>
    <p id="welcomeName"></p>
    <input type="text" id="partner" placeholder="Имя партнёра">
    <input type="date" id="startDate">
    <button onclick="registerUser()">Начать</button>
    <div id="regError"></div>
  </div>

  <div id="main" class="hidden"></div>

  <!-- Скрипт регистрации и инициализации пользователя -->
  <script>
    let tg = window.Telegram.WebApp;
    let userData = null;

    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
      const user = tg.initDataUnsafe.user;
      const userId = user.id;
      const fullName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
      const photoUrl = user.photo_url || '';
      userData = { user_id: userId, name: fullName, photo: photoUrl };
      document.getElementById('welcomeName').innerText = `Привет, ${fullName}`;
    } else {
      const fallbackId = localStorage.getItem('fake_user_id') || Math.floor(Math.random() * 1000000000);
      localStorage.setItem('fake_user_id', fallbackId);
      userData = { user_id: fallbackId, name: 'Пользователь', photo: '' };
      document.getElementById('welcomeName').innerText = `Привет!`;
    }

    async function registerUser() {
      const partner = document.getElementById('partner').value.trim();
      const startDate = document.getElementById('startDate').value;
      if (!partner || !startDate) {
        document.getElementById('regError').innerText = "Пожалуйста, заполните все поля.";
        return;
      }

      const payload = {
        user_id: userData.user_id,
        name: userData.name,
        partner: partner,
        date: startDate
      };

      try {
        const res = await fetch('save_user.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        if (text.trim() === "OK") {
          localStorage.setItem('user_data', JSON.stringify(payload));
          window.location.reload(); // перезагрузка, остальное загружается из внешних скриптов
        } else {
          document.getElementById('regError').innerText = "Ошибка при сохранении: " + text;
        }
      } catch (e) {
        document.getElementById('regError').innerText = "Ошибка подключения к серверу";
      }
    }

    window.onload = () => {
      const saved = localStorage.getItem('user_data');
      if (saved) {
        const data = JSON.parse(saved);
        // дальнейшая логика теперь обрабатывается внешними модулями
        document.getElementById('register').classList.add('hidden');
        document.getElementById('main').classList.remove('hidden');
      }
    };
  </script>

  <!-- Внешние модули -->
  <script src="js/ui.js"></script>
  <script src="js/activity.js"></script>
  <script src="js/quests.js"></script>
  <script src="js/dates.js"></script>
</body>
</html>